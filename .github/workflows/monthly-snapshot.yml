name: Monthly Asset Snapshot

on:
  schedule:
    # Run at 03:00 UTC (12:00 KST) on the last few days of each month
    - cron: '0 3 28-31 * *'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force snapshot regardless of last-day check (1 to enable)'
        required: false
        default: '0'

jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Validate required secret
        run: |
          if [ -z "${{ secrets.SWA_APP_BASE_URL }}" ]; then
            echo "SWA_APP_BASE_URL secret is not set"
            exit 1
          fi

      - name: Trigger monthly snapshot endpoint
        env:
          BASE_URL: ${{ secrets.SWA_APP_BASE_URL }}
          FORCE: ${{ github.event.inputs.force || '0' }}
          API_SECRET: ${{ secrets.API_SECRET }}
        run: |
          URL="${BASE_URL%/}/api/monthly-snapshot"
          if [ "$FORCE" = "1" ]; then
            URL="$URL?force=1"
          fi

          echo "Calling: $URL"
          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" -X POST "$URL" \
            -H "x-api-key: $API_SECRET")
          cat response.json

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Request failed with HTTP $HTTP_CODE"
            exit 1
          fi
